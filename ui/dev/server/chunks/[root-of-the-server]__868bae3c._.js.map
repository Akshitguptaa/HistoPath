{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 106, "column": 0}, "map": {"version":3,"sources":["file:///home/sudolife/Documents/sudo/histopath/lib/kb.ts"],"sourcesContent":["// Define the structure for a knowledge base entry\ninterface KBEntry {\n  id: string;\n  title: string;\n  content: string;\n  keywords: string[];\n}\n\n// Your externalized knowledge base\nexport const knowledgeBase: KBEntry[] = [\n  {\n    id: 'histopathology',\n    title: 'Histopathology Definition',\n    content: 'The microscopic examination of tissue to study the manifestations of disease.',\n    keywords: ['histopathology', 'what is histopathology', 'tissue', 'disease']\n  },\n  {\n    id: 'metastasis',\n    title: 'Metastasis Definition',\n    content: 'The spread of cancer cells from the place where they first formed to another part of the body. In lymph nodes, this is a critical indicator of cancer progression, particularly in breast cancer.',\n    keywords: ['metastasis', 'metastatic', 'spread', 'cancer', 'lymph node']\n  },\n  {\n    id: 'tumor-patch',\n    title: 'Tumor Patch',\n    content: 'A small section (e.g., 96x96 pixels) of a whole-slide image (WSI) of a tissue sample. Analysis is often done at the patch level.',\n    keywords: ['patch', 'tumor patch', 'wsi', 'whole-slide image']\n  },\n  {\n    id: 'model',\n    title: 'CNN Model Information',\n    content: 'A Convolutional Neural Network (CNN) based on the ResNet50 architecture. It\\'s trained to perform binary classification (Metastatic vs. Non-Metastatic).',\n    keywords: ['model', 'cnn', 'convolutional neural network', 'resnet50', 'classification']\n  },\n  {\n    id: 'dataset',\n    title: 'Dataset Information',\n    content: 'The model was trained on the PatchCamelyon (PCam) dataset. PCam consists of hundreds of thousands of 96x96 pixel image patches extracted from lymph node WSIs. Each patch is labeled as containing metastatic tissue or not.',\n    keywords: ['dataset', 'pcam', 'patchcamelyon', 'training', 'trained']\n  },\n  {\n    id: 'grad-cam',\n    title: 'Grad-CAM (Heatmap)',\n    content: 'Grad-CAM (Gradient-weighted Class Activation Mapping) is the technique used to generate heatmaps. The heatmap visually indicates which regions of the image patch were most influential in the model\\'s prediction. \"Hotter\" areas (e.g., red/yellow) signify regions the model focused on to make its decision. This helps in understanding and trusting the model\\'s output.',\n    keywords: ['grad-cam', 'gradcam', 'heatmap', 'visualization', 'explain', 'why', 'hot', 'hotspot']\n  }\n];\n\n/**\n * The Retriever function.\n * This is a simple keyword-based search.\n * A more advanced system would use vector embeddings for semantic search.\n */\nexport const retrieveContext = (prompt: string): string | null => {\n  const lowerCasePrompt = prompt.toLowerCase();\n  \n  // Find all KB entries that have at least one matching keyword\n  const relevantEntries = knowledgeBase.filter(entry => \n    entry.keywords.some(keyword => lowerCasePrompt.includes(keyword))\n  );\n\n  if (relevantEntries.length === 0) {\n    return null; // No context found\n  }\n\n  // Combine the content of all relevant entries to form the context\n  const context = relevantEntries\n    .map(entry => `Context on \"${entry.title}\": ${entry.content}`)\n    .join('\\n\\n');\n    \n  return context;\n};"],"names":[],"mappings":"AAAA,kDAAkD;;;;;;;AAS3C,MAAM,gBAA2B;IACtC;QACE,IAAI;QACJ,OAAO;QACP,SAAS;QACT,UAAU;YAAC;YAAkB;YAA0B;YAAU;SAAU;IAC7E;IACA;QACE,IAAI;QACJ,OAAO;QACP,SAAS;QACT,UAAU;YAAC;YAAc;YAAc;YAAU;YAAU;SAAa;IAC1E;IACA;QACE,IAAI;QACJ,OAAO;QACP,SAAS;QACT,UAAU;YAAC;YAAS;YAAe;YAAO;SAAoB;IAChE;IACA;QACE,IAAI;QACJ,OAAO;QACP,SAAS;QACT,UAAU;YAAC;YAAS;YAAO;YAAgC;YAAY;SAAiB;IAC1F;IACA;QACE,IAAI;QACJ,OAAO;QACP,SAAS;QACT,UAAU;YAAC;YAAW;YAAQ;YAAiB;YAAY;SAAU;IACvE;IACA;QACE,IAAI;QACJ,OAAO;QACP,SAAS;QACT,UAAU;YAAC;YAAY;YAAW;YAAW;YAAiB;YAAW;YAAO;YAAO;SAAU;IACnG;CACD;AAOM,MAAM,kBAAkB,CAAC;IAC9B,MAAM,kBAAkB,OAAO,WAAW;IAE1C,8DAA8D;IAC9D,MAAM,kBAAkB,cAAc,MAAM,CAAC,CAAA,QAC3C,MAAM,QAAQ,CAAC,IAAI,CAAC,CAAA,UAAW,gBAAgB,QAAQ,CAAC;IAG1D,IAAI,gBAAgB,MAAM,KAAK,GAAG;QAChC,OAAO,MAAM,mBAAmB;IAClC;IAEA,kEAAkE;IAClE,MAAM,UAAU,gBACb,GAAG,CAAC,CAAA,QAAS,CAAC,YAAY,EAAE,MAAM,KAAK,CAAC,GAAG,EAAE,MAAM,OAAO,EAAE,EAC5D,IAAI,CAAC;IAER,OAAO;AACT","debugId":null}},
    {"offset": {"line": 203, "column": 0}, "map": {"version":3,"sources":["file:///home/sudolife/Documents/sudo/histopath/app/api/chat/route.ts"],"sourcesContent":["import Groq from 'groq-sdk';\nimport { AnalysisResult, ChatMessage } from \"@/types\";\nimport { NextResponse } from 'next/server';\nimport { retrieveContext } from '@/lib/kb'; // <-- Import our new retriever\n\n// Get API key from environment variables\nconst apiKey = process.env.GROQ_API_KEY;\nif (!apiKey) {\n  throw new Error(\"GROQ_API_KEY is not defined in environment variables\");\n}\n\nconst groq = new Groq({ apiKey });\nconst model = \"llama-3.3-70b-versatile\";\n\n// This is the new, simple base persona. The KB is no longer hard-coded.\nconst baseSystemInstruction = `You are 'Histopath', a helpful AI assistant specializing in histopathology and cancer detection. Your purpose is to assist clinicians and researchers.\n- Be concise, clear, and professional.\n- Explain technical terms simply.\n- **Crucially, you must never provide a medical diagnosis or treatment advice.** You are an informational tool, not a substitute for a qualified pathologist.\n- Use the provided context to answer the user's questions. If no context is provided or it's not relevant, use your general knowledge.\n---\n`;\n\nexport async function POST(request: Request) {\n  try {\n    const { prompt, history, analysisResult } = (await request.json()) as {\n      prompt: string;\n      history: ChatMessage[];\n      analysisResult: AnalysisResult | null;\n    };\n\n    // --- RAG: Retrieval Step ---\n    // 1. Retrieve KB context based on the user's prompt\n    const kbContext = retrieveContext(prompt);\n\n    // --- RAG: Augmentation Step ---\n    // 2. Build the augmented system prompt\n    let augmentedSystemInstruction = baseSystemInstruction;\n    \n    // 2a. Add the dynamic analysis context (if it exists)\n    if (analysisResult) {\n      augmentedSystemInstruction += `\n**Current Image Analysis Context:**\n- The user has just analyzed an image patch.\n- **Model Prediction:** ${analysisResult.prediction}\n- **Confidence Score:** ${Math.round(analysisResult.confidence * 100)}%\n- A Grad-CAM heatmap has been generated. Use this to inform your answer.\n---\n`;\n    }\n\n    // 2b. Add the retrieved KB context (if it was found)\n    if (kbContext) {\n      augmentedSystemInstruction += `\n**Retrieved Knowledge Base Context:**\n(Use this information to answer the user's question)\n${kbContext}\n---\n`;\n    }\n\n    // 3. Construct the messages array for Groq\n    const messages: Groq.Chat.CompletionCreateParams.Message[] = [\n      {\n        role: \"system\",\n        content: augmentedSystemInstruction,\n      },\n    ];\n\n    // 4. Map the existing history\n    // The 'history' from the client already includes the latest user prompt\n    history.forEach(msg => {\n      messages.push({\n        role: msg.role === 'model' ? 'assistant' : 'user',\n        content: msg.parts[0].text,\n      });\n    });\n    \n    // --- RAG: Generation Step ---\n    const chatCompletion = await groq.chat.completions.create({\n      messages: messages,\n      model: model,\n    });\n\n    const responseText = chatCompletion.choices[0]?.message?.content || \"\";\n\n    // Send the response back to the client\n    return NextResponse.json({ response: responseText });\n\n  } catch (error) {\n    console.error(\"Error in chat API route:\", error);\n    return NextResponse.json(\n      { error: \"Failed to get a response from the AI assistant.\" },\n      { status: 500 }\n    );\n  }\n}"],"names":[],"mappings":";;;;AAAA;AAEA;AACA,kNAA4C,+BAA+B;;;;AAE3E,yCAAyC;AACzC,MAAM,SAAS,QAAQ,GAAG,CAAC,YAAY;AACvC,IAAI,CAAC,QAAQ;IACX,MAAM,IAAI,MAAM;AAClB;AAEA,MAAM,OAAO,IAAI,+KAAI,CAAC;IAAE;AAAO;AAC/B,MAAM,QAAQ;AAEd,wEAAwE;AACxE,MAAM,wBAAwB,CAAC;;;;;;AAM/B,CAAC;AAEM,eAAe,KAAK,OAAgB;IACzC,IAAI;QACF,MAAM,EAAE,MAAM,EAAE,OAAO,EAAE,cAAc,EAAE,GAAI,MAAM,QAAQ,IAAI;QAM/D,8BAA8B;QAC9B,oDAAoD;QACpD,MAAM,YAAY,IAAA,2IAAe,EAAC;QAElC,iCAAiC;QACjC,uCAAuC;QACvC,IAAI,6BAA6B;QAEjC,sDAAsD;QACtD,IAAI,gBAAgB;YAClB,8BAA8B,CAAC;;;wBAGb,EAAE,eAAe,UAAU,CAAC;wBAC5B,EAAE,KAAK,KAAK,CAAC,eAAe,UAAU,GAAG,KAAK;;;AAGtE,CAAC;QACG;QAEA,qDAAqD;QACrD,IAAI,WAAW;YACb,8BAA8B,CAAC;;;AAGrC,EAAE,UAAU;;AAEZ,CAAC;QACG;QAEA,2CAA2C;QAC3C,MAAM,WAAuD;YAC3D;gBACE,MAAM;gBACN,SAAS;YACX;SACD;QAED,8BAA8B;QAC9B,wEAAwE;QACxE,QAAQ,OAAO,CAAC,CAAA;YACd,SAAS,IAAI,CAAC;gBACZ,MAAM,IAAI,IAAI,KAAK,UAAU,cAAc;gBAC3C,SAAS,IAAI,KAAK,CAAC,EAAE,CAAC,IAAI;YAC5B;QACF;QAEA,+BAA+B;QAC/B,MAAM,iBAAiB,MAAM,KAAK,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC;YACxD,UAAU;YACV,OAAO;QACT;QAEA,MAAM,eAAe,eAAe,OAAO,CAAC,EAAE,EAAE,SAAS,WAAW;QAEpE,uCAAuC;QACvC,OAAO,6JAAY,CAAC,IAAI,CAAC;YAAE,UAAU;QAAa;IAEpD,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,4BAA4B;QAC1C,OAAO,6JAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAAkD,GAC3D;YAAE,QAAQ;QAAI;IAElB;AACF","debugId":null}}]
}